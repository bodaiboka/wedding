<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nini + Ricsi</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="canvas-container">
        <canvas id="wedding-canvas"></canvas>
    </div>

    <div class="welcome" >
        <div class="welcome-icon">É</div>

        <p data-translate-key="intro_1" class="welcome-text" id="guest-names">Kedves szerettünk!</p>
        <p data-translate-key="intro_1_1" class="welcome-text">Örömmel értesítünk, hogy</p>

        <div class="welcome-title"><h1>ichárnin</h1></div>

        <p data-translate-key="intro_2" class="welcome-text">örök hűséget fogadunk egymásnak, ezért meghívunk titeket esküvőnkre, melynek időpontja</p>

        <div class="date">
            <div data-translate-key="july" class="month"><p>július</p></div>
            <div class="day"><p>28</p><p data-translate-key="friday">péntek</p></div>
            <div class="year"><p>2023</p></div>
        </div>

        <div class="info">
            <div class="details shake-rep">
                <p data-translate-key="details">részletek</p>
                <i class="bi bi-chevron-double-down"></i>
                <!-- <i class="bi bi-chevron-double-up"></i> -->
                
            </div>
    
            <div class="info-bar">
                <div class="church-btn">&#x47;</div>
                <div class="civil-btn">&#x50;</div>
                <div class="dinner-btn">&#xFF;</div>
                <div class="cake-btn">&#xB6;</div>
                <div class="info-btn">&#xB4;</div>
            </div>
        </div>
    </div>

    <div class="info-details-container start">
        <div class="info-details-section">
            <p class="info-details-time">15:00</p>
            <h2 data-translate-key="church_title">Templomi esküvő</h2>
            <a href="https://goo.gl/maps/Sey7AfuV1kieLpu86">
            <p class="google-maps">Mindszenti templom</p>
            <p class="google-maps">Miskolc, Mindszent tér 2-4, 3530 <i class="bi bi-geo-alt-fill"></i></p></a>
            <p class="info-details-note" data-translate-key="church_description">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Alias nesciunt eius doloremque fugiat dolores!</p>
        </div>
        <div class="info-details-section">
            <p class="info-details-time">17:00</p>
            <h2 data-translate-key="civil_title">Polgári esküvő</h2>
            <a href="https://goo.gl/maps/j8kCfwNF5rxgNoTbA">
            <p class="google-maps">Molnár Csárda Rendezvénysátor</p>
            <p class="google-maps">Miskolc, Vadas Jenő u. 1, 3517 <i class="bi bi-geo-alt-fill"></i></p></a>
            <p class="info-details-note" data-translate-key="civil_description">A szertartás előtt frissítő falatokkal és italokkal várunk benneteket a helyszínen.</p>
        </div>
        <div class="info-details-section">
            <p class="info-details-time">19:00</p>
            <h2 data-translate-key="dinner_title">Vacsora</h2>
            <p data-translate-key="dinner_description"></p>
        </div>
        <div class="info-details-section">
            <p class="info-details-time">23:00</p>
            <h2 data-translate-key="cake_title">Torta</h2>
            <p data-translate-key="cake_description">Szívünk édességét és szerelmünk ízét megosztjuk veletek, amint az esküvői tortánkba beleharapunk. Várjuk, hogy együtt ünnepeljünk ebben a különleges pillanatban.</p>
        </div>
        <div class="info-details-section">
            <h2 data-translate-key="info_title">Információ</h2>
            <p class="info-details-respond-p" data-translate-key="info_description"></p>
            <form>
                <div class="info-table">
                    <div class="info-table-titles">
                        <div data-translate-key="info_name" class="name">Name</div>
                        <div data-translate-key="info_attending" class="attend">Attending</div>
                        <div data-translate-key="info_vegan" class="vegetarian">Vegetarian</div>
                        <div data-translate-key="info_age3" class="age">Age under 3</div>
                    </div>
                    <div class="info-table-data">

                    </div>
                </div>

                <form  action="#">
                    <div class="info-form">
                        <input type="text" id="myInput" placeholder="Name">
                        <button type="button" data-translate-key="info_add_guest" class="info-add-guest-button"></button>
                    </div>                    
                </form>
                <button data-translate-key="info_submit" class="info-send-button" type="button">Send answer</button>
            </form>
        </div>
    </div>

    <div id="popup" class="popup">
        <span id="popup-message"></span>
      </div>
      
    
    <script type="module" src="graphics.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <script>
        $(document).ready(function() {

            function showToast(message, pre, post) {
                var popup = $('#popup');
                var popupMessage = $('#popup-message');
                
                if (!popup.is(":visible")) {
                    if (pre != null) pre()
                    popupMessage.text(message);
                    popup.show(200);
                    
                    setTimeout(function() {
                        popup.hide(200)
                        if (post != null) post()
                    }, 4000);
                }  
            }

            let oneTimeHelp = false;
            let lang  = 'hu';
            let strings = {

                "hu": {
                    intro_1: "Kedves ",
                    intro_1_1: "Örömmel értesítünk, hogy",
                    intro_2: "örök hűséget fogadunk egymásnak, ezért meghívunk titeket esküvőnkre, melynek időpontja",
                    july: "július",
                    friday: "péntek",
                    details: "Részletek",
                    church_title: "Templomi Esküvő",
                    church_description: "Kérünk benneteket, hogy 10 perccel a szertartás kezdete előtt foglaljatok helyet a templomban. Parkolás a templom saját udvarán lehetséges.",
                    civil_title: "Polgári Esküvő",
                    civil_description: "A ceremónia előtt frissítő falatokkal és italokkal várunk benneteket a helyszínen.",
                    dinner_title: "Vacsora",
                    dinner_description: "Az esküvői lakoma nem csak az ételekről szól, hanem az öröm, a nevetés és a szeretet megosztásáról is. Ezen az estén egy hangulatos sátras vacsora mellett kívánunk veletek koccintani a jövőre.",
                    cake_title: "Torta",
                    cake_description: "Csatlakozzatok hozzánk, amint egy édes szelettel megpecsételjük az életünk új fejezetét. A torta íze olyan, mint a mi szerelmünk: édes és ellenállhatatlan :)",
                    info_title: "Visszajelzés",
                    info_description: "Kérünk benneteket, hogy jelezzetek vissza az alábbi form kitöltésével legkésőbb július 23-ig. A '3 év alatti' oszlop a legfeljebb 3 éves gyermekekre vonatkozik.",
                    info_name: "Név",
                    info_attending: "Részt vesz",
                    info_vegan: "Vegán",
                    info_age3: "3 év alatti",
                    info_note: "Megjegyzés",
                    input_placeholder: "Kísérő neve",
                    info_add_guest: "Kísérő hozzáadása",
                    info_submit: "Válasz elküldése",
                    popup_companion: "Először add meg a kísérő nevét a mezőben.",
                    popup_respond_success: "Köszönjük, megkaptuk a válaszod.",
                    tipp_google_maps: "Kattints a címre, hogy ha szeretnéd megtekinteni google maps-en is.",
                    tipp_respond: "Köszönjük, hogy már válaszoltál. Július 23-ig még módosíthatod válaszodat, csak küldd el újra."
                },

                "en": {
                    intro_1: "Dear ",
                    intro_1_1: "We are delighted to inform you that",
                    intro_2: "we are pledging eternal fidelity to each other, and therefore we invite you to our wedding, which will be held on",
                    july: "July",
                    friday: "Friday",
                    details: "Details",
                    church_title: "Church Ceremony",
                    church_description: "We kindly ask you to take your seats in the church 10 minutes before the ceremony begins. Parking is possible in the church's own courtyard.",
                    civil_title: "Civil Ceremony",
                    civil_description: "We will be waiting for you with refreshing bites and drinks at the venue before the ceremony.",
                    dinner_title: "Dinner",
                    dinner_description: "The wedding feast is not just about the food, but also about sharing joy, laughter, and love. On this evening, we wish to toast to the future with you beside a cozy tented dinner.",
                    cake_title: "Cake",
                    cake_description: "Join us as we seal the new chapter of our lives with a sweet slice. The taste of the cake is like our love: sweet and irresistible. :)",
                    info_title: "Please respond",
                    info_description: "We kindly ask you to respond by filling out the form below by July 23 at the latest. The 'up to 3y old' column refers to children up to 3 years old.",
                    info_name: "Name",
                    info_attending: "Will attend",
                    info_vegan: "Vegan",
                    info_age3: "up to 3y old",
                    info_note: "Note",
                    input_placeholder: "Name",
                    info_add_guest: "Add a companion",
                    info_submit: "Submit a reply",
                    popup_companion: "First type your companion's name into the input field.",
                    popup_respond_success: "Thank you, we have received your response.",
                    tipp_google_maps: "Click on the address if you would like to view it on Google Maps as well.",
                    tipp_respond: "Thank you for your response. You can modify your answer until July 23, just send it again."
                },

                "ge": {
                    intro_1: "Dear ",
                    intro_1_1: "We are delighted to inform you that",
                    intro_2: "örök hűséget fogadunk egymásnak, ezért meghívunk titeket esküvőnkre, melynek időpontja",
                    july: "július",
                    friday: "péntek",
                    details: "részletek",
                    church_title: "Templomi Esküvő",
                    church_description: "",
                    civil_title: "Polgári Esküvő",
                    civil_description: "",
                    dinner_title: "Vacsora",
                    dinner_description: "",
                    cake_title: "Torta",
                    cake_description: "",
                    info_title: "Visszajelzés",
                    info_description: "",
                    info_name: "Név",
                    info_attending: "Részt vesz",
                    info_vegan: "Vegán",
                    info_age3: "3 év alatt",
                    info_note: "Megjegyzés",
                    input_placeholder: "Name",
                    info_add_guest: "Kísérő hozzáadása",
                    info_submit: "Válasz elküldése",
                    popup_companion: "Először add meg a kísérő nevét a mezőben.",
                    popup_respond_success: "Köszönjük, megkaptuk a válaszod.",
                    tipp_google_maps: "Click on the address if you would like to view it on Google Maps as well.",
                    tipp_respond: "Thank you for your response. You can modify your answer until July 23, just send it again."
                }

            }

            let infoTimeOut;
            isInfoOpen = false;
            $welcome = $('.welcome');
            $weddingCanvas = $('#wedding-canvas');
            $detailsButton = $('.info .details');
            $infoBar = $('.info-bar');
            $churchBtn = $('.church-btn');
            $civilBtn = $('.civil-btn');
            $dinnerBtn = $('.dinner-btn');
            $cakeBtn = $('.cake-btn');
            $infoDetailsContainer = $('.info-details-container');
            $welcomeTitle = $('.welcome-title');
            $infoTable = $(".info-table");
            $infoTableData = $(".info-table-data");
            $infoSendButton = $(".info-send-button");
            let welcomeOfset;
            let welcomeTitleOffset = $('.welcome .info').offset().top - $welcomeTitle.outerHeight(true);
            $('.info-bar').css({
                'display': 'none'
            });
            $infoDetailsContainer.css({
                'display': 'none'
            });
            
            const toggleInfo = () => {
                if (isInfoOpen) {
                    welcomeOfset = $('body').height()/2 - $welcome.height()/2;
                    console.log($('body').height(), $welcome.height(), welcomeOfset);
                    $welcome.css({
                        'top': `${welcomeOfset}px`
                    });
                    
                } else {
                    $welcome.css({
                            'top': `${0 - welcomeTitleOffset}px`
                    });
                    let infoOffset =  $welcomeTitle.outerHeight(true) + $('.info').outerHeight(true);
                    console.log('infoOffset', infoOffset);
                    $infoDetailsContainer.css({
                        'top': `${infoOffset}px`
                    });
                }
                isInfoOpen = !isInfoOpen;
            }

            const onResize = () => {
                if (!isInfoOpen) {
                    let welcomeOfset = $('body').height()/2 - $welcome.height()/2;
                    $welcome.css({
                        'top': `${welcomeOfset}px`
                    });
                }
                $weddingCanvas.width($('.canvas-container').width());
            }

            const getQueryParam = (param) => {
                let params = new URLSearchParams(window.location.search);
                return params.get(param);
            }

            onResize();

            $(window).on('resize', onResize);

            $detailsButton.on('click', (event) => {
                if (infoTimeOut) {
                    clearTimeout(infoTimeOut);
                }
                console.log('click');
                if (isInfoOpen) {
                    $infoDetailsContainer.addClass('start')
                    $infoDetailsContainer.fadeOut(500, () => {
                            $('.info-bar').slideToggle(350, () => {
                            toggleInfo();
                            $('.welcome > p').toggleClass('transparent');
                            $('.welcome .date').toggleClass('transparent');
                            $detailsButton.addClass('shake-rep')
                        });
                    })
                } else {
                    $detailsButton.removeClass('shake-rep')
                    $('.info-bar').slideToggle(350, () => {
                            toggleInfo();
                            $('.welcome > p').toggleClass('transparent');
                            $('.welcome .date').toggleClass('transparent');
                            infoTimeOut = setTimeout(() => {
                                $infoDetailsContainer.fadeIn(500);
                                $infoDetailsContainer.removeClass('start')
                                if (!oneTimeHelp) {
                                    setTimeout(() => {
                                        console.log("one tim help");
                                        showToast(strings[lang]['tipp_google_maps'], null, null)
                                        oneTimeHelp = true;
                                        $('.google-maps').addClass('shake');
                                    }, 4000)
                                }
                            }, 500)
                            
                    })
                }
                
            })

            $infoBar.on("click", "div", function() {
                $infoBar.css({
                    '--translate-btn': `${$(this).index() * $(this).outerWidth(true)}px`
                });
                container = document.querySelector('.info-details-container');
                container.scrollTo($(this).index() * $infoDetailsContainer.first().outerWidth(true), 250);
            });

            let groupId = getQueryParam('g');
            if (groupId == null) {
                groupId = localStorage.getItem('groupId');
            } else {
                localStorage.setItem('groupId', groupId);
            }

            $.get(`https://api.nino-ricsi.wedding:3000/groups/${groupId}`, function(data) {
                console.log(data);
                lang = data['lang'];
                if (lang != 'hu' && lang != 'en' && lang != 'ge') {
                    lang = 'hu';
                }
                // Translate the content
                $("[data-translate-key]").each(function() {
                    var key = $(this).data("translate-key");
                    $(this).html(strings[lang][key]);
                });
                $('#myInput').attr('placeholder', strings[lang]['input_placeholder']);
                $('#guest-names').append(`${data['address']},`);
                if (data['respond'] == true) {
                    console.log("volt respond");
                    $('.info-details-respond-p').text(strings[lang]['tipp_respond']);
                }
            })


            $.get(`https://api.nino-ricsi.wedding:3000/groups/${groupId}/guests`, function(data) {
                data.forEach(element => {
                    console.log(element._id);
                    $infoTableData.append(
                        `<div class="info-table-values" data-id="${element._id}">
                            <div class="name">${element.name}</div>
                            <div><input class="attending" type="checkbox" ${element.attending?'checked':''}></div>
                            <div><input class="vegetarian" type="checkbox" ${element.vegetarian?'checked':''}></div>
                            <div><input class="age3" type="checkbox" ${element.age3?'checked':''}></div>
                        </div>`
                    )
                });
            })

            $('.info-add-guest-button').on('click', (event) => {
                event.preventDefault();
                var inputValue = $('#myInput').val();
                if (inputValue == "" || inputValue == null) {
                    showToast(strings[lang]['popup_companion'], () => $('#myInput').addClass('shake'), () => $('#myInput').removeClass('shake'))
                } else {
                    $infoTableData.append(
                    `<div class="info-table-values" data-id="">
                                <div class="name">${inputValue}</div>
                                <div><input class="attending" type="checkbox" 'checked'}></div>
                                <div><input class="vegetarian" type="checkbox"}></div>
                                <div><input class="age3" type="checkbox"}></div>
                    </div>`
                    )
                }
            })

            function respondSent() {
                $.ajax({
                    url: `https://api.nino-ricsi.wedding:3000/groups/${groupId}`,
                    type: 'PATCH',
                    contentType: 'application/json',
                    data: JSON.stringify({respond: true}),
                    success: function(data) {
                        showToast(strings[lang]['popup_respond_success']);
                        $('.info-details-respond-p').text(strings[lang]['tipp_respond']);
                    },
                    error: function(error) {
                        console.log('Error:', error);
                    }
                });
            }

            let data = [];

            $infoSendButton.on("click", (event) => {
                data.length = 0;
                $(".info-table-values").each(function() {
                    if ($(this).data('id') != "") {
                        data.push({
                            _id: $(this).data('id'),
                            attending: $(this).find('.attending').is(':checked'),
                            vegetarian: $(this).find('.vegetarian').is(':checked'),
                            age3: $(this).find('.age3').is(':checked')
                        })
                    } else {
                        console.log("nincs data");
                        data.push({
                            name: $(this).find('.name').text(),
                            group: groupId,
                            attending: $(this).find('.attending').is(':checked'),
                            vegetarian: $(this).find('.vegetarian').is(':checked'),
                            age3: $(this).find('.age3').is(':checked')
                        })
                    }
                });
                $.ajax({
                    url: "https://api.nino-ricsi.wedding:3000/guests",
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function(data) {
                        console.log(data);
                        respondSent();
                    },
                    error: function(error) {
                        console.log('Error:', error);
                    }
                });
            })
            
            // Get the scroll container element
            var scrollContainer = document.getElementById(".info-details-container");

            // Add an event listener for the scroll-snap-align event
            scrollContainer.addEventListener("scroll-snap-align", handleSnapAlign);

            // Function to handle the scroll-snap-align event
            function handleSnapAlign(event) {
            var currentSnapIndex = event.target.scrollLeft / event.target.clientWidth;
            var nextSnapIndex = Math.ceil(currentSnapIndex);

            console.log("Scrolled to next snap point: " + nextSnapIndex);
}

        })
    </script>
</body>
</html>