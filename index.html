<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nini + Ricsi</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="canvas-container">
        <canvas id="wedding-canvas"></canvas>
    </div>

    <div class="welcome" >
        <div class="welcome-icon">É</div>

        <p data-translate-key="intro_1" class="welcome-text" id="guest-names">Kedves szerettünk!</p>
        <p data-translate-key="intro_1_1" class="welcome-text">Örömmel értesítünk, hogy</p>

        <div class="welcome-title"><h1>ichárnin</h1></div>

        <p data-translate-key="intro_2" class="welcome-text">örök hűséget fogadunk egymásnak, ezért meghívunk titeket esküvőnkre, melynek időpontja</p>

        <div class="date">
            <div data-translate-key="july" class="month"><p>július</p></div>
            <div class="day"><p>28</p><p data-translate-key="friday">péntek</p></div>
            <div class="year"><p>2023</p></div>
        </div>

        <div class="info">
            <div class="details">
                <p data-translate-key="details">részletek</p>
                <i class="bi bi-chevron-double-down"></i>
                <!-- <i class="bi bi-chevron-double-up"></i> -->
                
            </div>
    
            <div class="info-bar">
                <div class="church-tbn">&#x47;</div>
                <div class="civil-btn">&#x50;</div>
                <div class="dinner-btn">&#xFF;</div>
                <div class="cake-btn">&#xB6;</div>
                <div class="info-btn">&#xB4;</div>
            </div>
        </div>
    </div>

    <div class="info-details-container start">
        <div class="info-details-section">
            <p class="info-details-time">15:00</p>
            <h2 data-translate-key="church_title">Templomi esküvő</h2>
            <p>Mindszenti templom</p>
            <p>Miskolc, Mindszent tér 2-4, 3530</p>
            <p class="info-details-note" data-translate-key="church_description">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Alias nesciunt eius doloremque fugiat dolores!</p>
        </div>
        <div class="info-details-section">
            <p class="info-details-time">17:00</p>
            <h2 data-translate-key="civil_title">Polgári esküvő</h2>
            <p>Molnár Csárda Rendezvénysátor</p>
            <p>Miskolc, Vadas Jenő u. 1, 3517</p>
            <p class="info-details-note" data-translate-key="civil_description">A szertartás előtt frissítő falatokkal és italokkal várunk benneteket a helyszínen.</p>
        </div>
        <div class="info-details-section">
            <p class="info-details-time">19:00</p>
            <h2 data-translate-key="dinner_title">Vacsora</h2>
            <p>Molnár Csárda Rendezvénysátor</p>
            <p>Miskolc, Vadas Jenő u. 1, 3517</p>
            <p data-translate-key="dinner_description"></p>
        </div>
        <div class="info-details-section">
            <h2 data-translate-key="cake_title">Torta</h2>
            <p data-translate-key="cake_description">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Alias nesciunt eius doloremque fugiat dolores!</p>
        </div>
        <div class="info-details-section">
            <h2 data-translate-key="info_title">Információ</h2>
            <form>
                <div class="info-table">
                    <div class="info-table-titles">
                        <div data-translate-key="info_name" class="name">Name</div>
                        <div data-translate-key="info_attending" class="attend">Attending</div>
                        <div data-translate-key="info_vegan" class="vegetarian">Vegetarian</div>
                        <div data-translate-key="info_age3" class="age">Age under 3</div>
                    </div>
                    <div class="info-table-data">

                    </div>
                </div>

                <form  action="#">
                    <div class="info-form">
                        <input type="text" id="myInput" placeholder="Name">
                        <button type="button" data-translate-key="info_add_guest" class="info-add-guest-button"></button>
                    </div>                    
                </form>
                <button data-translate-key="info_submit" class="info-send-button" type="button">Send answer</button>
            </form>
        </div>
    </div>

    <div id="popup" class="popup">
        <span id="popup-message"></span>
      </div>
      
    
    <script type="module" src="graphics.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <script>
        $(document).ready(function() {

            function showToast(message, pre, post) {
                var popup = $('#popup');
                var popupMessage = $('#popup-message');
                
                if (!popup.is(":visible")) {
                    if (pre != null) pre()
                    popupMessage.text(message);
                    popup.show(200);
                    
                    setTimeout(function() {
                        popup.hide(200)
                        if (post != null) post()
                    }, 4000);
                }  
            }

            let strings = {

                "hu": {
                    intro_1: "Kedves ",
                    intro_1_1: "Örömmel értesítünk, hogy",
                    intro_2: "örök hűséget fogadunk egymásnak, ezért meghívunk titeket esküvőnkre, melynek időpontja",
                    july: "július",
                    friday: "péntek",
                    details: "Részletek",
                    church_title: "Templomi Esküvő",
                    church_description: "Kérünk benneteket, hogy 10 perccel a szertartás kezdete előtt foglaljatok helyet a templomban. Parkolás a templom saját udvarán lehetséges.",
                    civil_title: "Polgári Esküvő",
                    civil_description: "A ceremónia előtt frissítő falatokkal és italokkal várunk benneteket a helyszínen.",
                    dinner_title: "Vacsora",
                    dinner_description: "A szertartás előtt frissítő falatokkal és italokkal várunk benneteket a helyszínen.",
                    cake_title: "Torta",
                    cake_description: "Lorem ipsum dolor sit amet, consectetur adipisicing elit. Alias nesciunt eius doloremque fugiat dolores!",
                    info_title: "Visszajelzés",
                    info_description: "Lorem ipsum dolor sit amet, consectetur adipisicing elit. Alias nesciunt eius doloremque fugiat dolores!",
                    info_name: "Név",
                    info_attending: "Részt vesz",
                    info_vegan: "Vegán",
                    info_age3: "3 év alatt",
                    info_note: "Megjegyzés",
                    info_add_guest: "Kísérő hozzáadása",
                    info_submit: "Válasz elküldése"
                },

                "en": {
                    intro_1: "Dear ",
                    intro_1_1: "We are delighted to inform you that",
                    intro_2: "we are pledging eternal fidelity to each other, and therefore we invite you to our wedding, which will be held on",
                    july: "July",
                    friday: "Friday",
                    details: "Details",
                    church_title: "Church Ceremony",
                    church_description: "Lorem ipsum dolor sit amet, consectetur adipisicing elit. Alias nesciunt eius doloremque fugiat dolores!",
                    civil_title: "Civil Ceremony",
                    civil_description: "Lorem ipsum dolor sit amet, consectetur adipisicing elit. Alias nesciunt eius doloremque fugiat dolores!",
                    dinner_title: "Dinner",
                    dinner_description: "Lorem ipsum dolor sit amet, consectetur adipisicing elit. Alias nesciunt eius doloremque fugiat dolores!",
                    cake_title: "Cake",
                    cake_description: "Lorem ipsum dolor sit amet, consectetur adipisicing elit. Alias nesciunt eius doloremque fugiat dolores!",
                    info_title: "Please respond",
                    info_description: "Lorem ipsum dolor sit amet, consectetur adipisicing elit. Alias nesciunt eius doloremque fugiat dolores!",
                    info_name: "Name",
                    info_attending: "Will attend",
                    info_vegan: "Vegan",
                    info_age3: "under 3y old",
                    info_note: "Note",
                    info_add_guest: "Add a companion",
                    info_submit: "Submit a reply"
                },

                "ge": {
                    intro_1: "Dear ",
                    intro_1_1: "We are delighted to inform you that",
                    intro_2: "örök hűséget fogadunk egymásnak, ezért meghívunk titeket esküvőnkre, melynek időpontja",
                    july: "július",
                    friday: "péntek",
                    details: "részletek",
                    church_title: "Templomi Esküvő",
                    church_description: "",
                    civil_title: "Polgári Esküvő",
                    civil_description: "",
                    dinner_title: "Vacsora",
                    dinner_description: "",
                    cake_title: "Torta",
                    cake_description: "",
                    info_title: "Visszajelzés",
                    info_description: "",
                    info_name: "Név",
                    info_attending: "Részt vesz",
                    info_vegan: "Vegán",
                    info_age3: "3 év alatt",
                    info_note: "Megjegyzés",
                    info_add_guest: "Kísérő hozzáadása",
                    info_submit: "Válasz elküldése"
                }

            }

            let infoTimeOut;
            isInfoOpen = false;
            $welcome = $('.welcome');
            $weddingCanvas = $('#wedding-canvas');
            $detailsButton = $('.info .details');
            $infoBar = $('.info-bar');
            $churchBtn = $('.church-btn');
            $civilBtn = $('.civil-btn');
            $dinnerBtn = $('.dinner-btn');
            $cakeBtn = $('.cake-btn');
            $infoDetailsContainer = $('.info-details-container');
            $welcomeTitle = $('.welcome-title');
            $infoTable = $(".info-table");
            $infoTableData = $(".info-table-data");
            $infoSendButton = $(".info-send-button");
            let welcomeOfset;
            let welcomeTitleOffset = $('.welcome .info').offset().top - $welcomeTitle.outerHeight(true);
            $('.info-bar').css({
                'display': 'none'
            });
            $infoDetailsContainer.css({
                'display': 'none'
            });
            
            const toggleInfo = () => {
                if (isInfoOpen) {
                    welcomeOfset = $('body').height()/2 - $welcome.height()/2;
                    console.log($('body').height(), $welcome.height(), welcomeOfset);
                    $welcome.css({
                        'top': `${welcomeOfset}px`
                    });
                    
                } else {
                    $welcome.css({
                            'top': `${0 - welcomeTitleOffset}px`
                    });
                    let infoOffset =  $welcomeTitle.outerHeight(true) + $('.info').outerHeight(true);
                    console.log('infoOffset', infoOffset);
                    $infoDetailsContainer.css({
                        'top': `${infoOffset}px`
                    });
                }
                isInfoOpen = !isInfoOpen;
            }

            const onResize = () => {
                if (!isInfoOpen) {
                    let welcomeOfset = $('body').height()/2 - $welcome.height()/2;
                    $welcome.css({
                        'top': `${welcomeOfset}px`
                    });
                }
                $weddingCanvas.width($('.canvas-container').width());
            }

            const getQueryParam = (param) => {
                let params = new URLSearchParams(window.location.search);
                return params.get(param);
            }

            onResize();

            $(window).on('resize', onResize);

            $detailsButton.on('click', (event) => {
                if (infoTimeOut) {
                    clearTimeout(infoTimeOut);
                }
                console.log('click');
                if (isInfoOpen) {
                    $infoDetailsContainer.addClass('start')
                    $infoDetailsContainer.fadeOut(500, () => {
                            $('.info-bar').slideToggle(350, () => {
                            toggleInfo();
                            $('.welcome > p').toggleClass('transparent');
                            $('.welcome .date').toggleClass('transparent');
                        });
                    })
                } else {
                    $('.info-bar').slideToggle(350, () => {
                            toggleInfo();
                            $('.welcome > p').toggleClass('transparent');
                            $('.welcome .date').toggleClass('transparent');
                            infoTimeOut = setTimeout(() => {
                                $infoDetailsContainer.fadeIn(500);
                                $infoDetailsContainer.removeClass('start')
                            }, 500)
                            
                    })
                }
                
            })

            $infoBar.on("click", "div", function() {
                $infoBar.css({
                    '--translate-btn': `${$(this).index() * $(this).outerWidth(true)}px`
                });
                container = document.querySelector('.info-details-container');
                container.scrollTo($(this).index() * $infoDetailsContainer.first().outerWidth(true), 250);
            });

            let groupId = getQueryParam('g');
            if (groupId == null) {
                groupId = localStorage.getItem('groupId');
            } else {
                localStorage.setItem('groupId', groupId);
            }

            $.get(`https://api.nino-ricsi.wedding:3000/groups/${groupId}`, function(data) {
                let lang = data['lang'];
                if (lang != 'hu' && lang != 'en' && lang != 'ge') {
                    lang = 'hu';
                }
                // Translate the content
                $("[data-translate-key]").each(function() {
                    var key = $(this).data("translate-key");
                    $(this).html(strings[lang][key]);
                });
                $('#guest-names').append(`${data['address']},`);
            })


            $.get(`https://api.nino-ricsi.wedding:3000/groups/${groupId}/guests`, function(data) {
                data.forEach(element => {
                    console.log(element._id);
                    $infoTableData.append(
                        `<div class="info-table-values" data-id="${element._id}">
                            <div class="name">${element.name}</div>
                            <div><input class="attending" type="checkbox" ${element.attending?'checked':''}></div>
                            <div><input class="vegetarian" type="checkbox" ${element.vegetarian?'checked':''}></div>
                            <div><input class="age3" type="checkbox" ${element.age3?'checked':''}></div>
                        </div>`
                    )
                });
            })

            $('.info-add-guest-button').on('click', (event) => {
                event.preventDefault();
                var inputValue = $('#myInput').val();
                if (inputValue == "" || inputValue == null) {
                    showToast("First type the guest's name into the input field.", () => $('#myInput').addClass('shake'), () => $('#myInput').removeClass('shake'))
                } else {
                    $infoTableData.append(
                    `<div class="info-table-values" data-id="">
                                <div class="name">${inputValue}</div>
                                <div><input class="attending" type="checkbox" 'checked'}></div>
                                <div><input class="vegetarian" type="checkbox"}></div>
                                <div><input class="age3" type="checkbox"}></div>
                    </div>`
                    )
                }
            })

            function respondSent() {
                $.ajax({
                    url: `https://api.nino-ricsi.wedding:3000/groups/${groupId}`,
                    type: 'PATCH',
                    contentType: 'application/json',
                    data: JSON.stringify({respond: true}),
                    success: function(data) {
                        showToast("Köszönjük, megkaptuk a válaszod.");
                    },
                    error: function(error) {
                        console.log('Error:', error);
                    }
                });
            }

            let data = [];

            $infoSendButton.on("click", (event) => {
                data.length = 0;
                $(".info-table-values").each(function() {
                    if ($(this).data('id') != "") {
                        data.push({
                            _id: $(this).data('id'),
                            attending: $(this).find('.attending').is(':checked'),
                            vegetarian: $(this).find('.vegetarian').is(':checked'),
                            age3: $(this).find('.age3').is(':checked')
                        })
                    } else {
                        console.log("nincs data");
                        data.push({
                            name: $(this).find('.name').text(),
                            group: groupId,
                            attending: $(this).find('.attending').is(':checked'),
                            vegetarian: $(this).find('.vegetarian').is(':checked'),
                            age3: $(this).find('.age3').is(':checked')
                        })
                    }
                });
                $.ajax({
                    url: "https://api.nino-ricsi.wedding:3000/guests",
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function(data) {
                        console.log(data);
                        respondSent();
                    },
                    error: function(error) {
                        console.log('Error:', error);
                    }
                });
            }) 

        })
    </script>
</body>
</html>