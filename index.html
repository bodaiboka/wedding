<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nini + Ricsi</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="canvas-container">
        <canvas id="wedding-canvas"></canvas>
    </div>

    <div class="welcome" >
        <div class="welcome-icon">É</div>

        <p class="welcome-text">Kedves szerettünk! Örömmel értesítünk, hogy</p>

        <div class="welcome-title"><h1>ichárnin</h1></div>

        <p>örök hűséget fogadunk egymásnak, ezért meghívunk titeket esküvőnkre, melynek időpontja</p>

        <div class="date">
            <div class="month"><p>július</p></div>
            <div class="day"><p>28</p><p>péntek</p></div>
            <div class="year"><p>2023</p></div>
        </div>

        <div class="info">
            <div class="details">
                <p>részletek</p>
                <i class="bi bi-chevron-double-down"></i>
                <!-- <i class="bi bi-chevron-double-up"></i> -->
                
            </div>
    
            <div class="info-bar">
                <div class="church-tbn">&#x47;</div>
                <div class="civil-btn">&#x50;</div>
                <div class="dinner-btn">&#xFF;</div>
                <div class="cake-btn">&#xB6;</div>
                <div class="info-btn">&#xB4;</div>
            </div>
        </div>
    </div>

    <div class="info-details-container start">
        <div class="info-details-section">
            <h2>Templomi esküvő</h2>
            <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Alias nesciunt eius doloremque fugiat dolores!</p>
        </div>
        <div class="info-details-section">
            <h2>Polgári esküvő</h2>
            <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Alias nesciunt eius doloremque fugiat dolores!</p>
        </div>
        <div class="info-details-section">
            <h2>Vacsora</h2>
            <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Alias nesciunt eius doloremque fugiat dolores!</p>
        </div>
        <div class="info-details-section">
            <h2>Torta</h2>
            <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Alias nesciunt eius doloremque fugiat dolores!</p>
        </div>
        <div class="info-details-section">
            <h2>Információ</h2>
            <form>
                <div class="info-table">
                    <div class="info-table-titles">
                        <div class="name">Name</div>
                        <div class="attend">Attending</div>
                        <div class="vegetarian">Vegetarian</div>
                        <div class="age">Age under 3</div>
                    </div>
                </div>
                <button type="button">Add guest</button>
                <button class="info-send-button" type="button">Send answer</button>
            </form>
        </div>
    </div>

    <script type="module" src="graphics.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            let infoTimeOut;
            isInfoOpen = false;
            $welcome = $('.welcome');
            $weddingCanvas = $('#wedding-canvas');
            $detailsButton = $('.info .details');
            $infoBar = $('.info-bar');
            $churchBtn = $('.church-btn');
            $civilBtn = $('.civil-btn');
            $dinnerBtn = $('.dinner-btn');
            $cakeBtn = $('.cake-btn');
            $infoDetailsContainer = $('.info-details-container');
            $welcomeTitle = $('.welcome-title');
            $infoTable = $(".info-table");
            $infoSendButton = $(".info-send-button");
            let welcomeOfset;
            let welcomeTitleOffset = $('.welcome .info').offset().top - $welcomeTitle.outerHeight(true);
            $('.info-bar').css({
                'display': 'none'
            });
            $infoDetailsContainer.css({
                'display': 'none'
            });
            
            const toggleInfo = () => {
                if (isInfoOpen) {
                    welcomeOfset = $('body').height()/2 - $welcome.height()/2;
                    console.log($('body').height(), $welcome.height(), welcomeOfset);
                    $welcome.css({
                        'top': `${welcomeOfset}px`
                    });
                    
                } else {
                    $welcome.css({
                            'top': `${0 - welcomeTitleOffset}px`
                    });
                    let infoOffset =  $welcomeTitle.outerHeight(true) + $('.info').outerHeight(true);
                    console.log('infoOffset', infoOffset);
                    $infoDetailsContainer.css({
                        'top': `${infoOffset}px`
                    });
                }
                isInfoOpen = !isInfoOpen;
            }

            const onResize = () => {
                if (!isInfoOpen) {
                    let welcomeOfset = $('body').height()/2 - $welcome.height()/2;
                    $welcome.css({
                        'top': `${welcomeOfset}px`
                    });
                }
                $weddingCanvas.width($('.canvas-container').width());
            }

            const getQueryParam = (param) => {
                let params = new URLSearchParams(window.location.search);
                return params.get(param);
            }

            onResize();

            $(window).on('resize', onResize);

            $detailsButton.on('click', (event) => {
                if (infoTimeOut) {
                    clearTimeout(infoTimeOut);
                }
                console.log('click');
                if (isInfoOpen) {
                    $infoDetailsContainer.addClass('start')
                    $infoDetailsContainer.fadeOut(500, () => {
                            $('.info-bar').slideToggle(350, () => {
                            toggleInfo();
                            $('.welcome > p').toggleClass('transparent');
                            $('.welcome .date').toggleClass('transparent');
                        });
                    })
                } else {
                    $('.info-bar').slideToggle(350, () => {
                            toggleInfo();
                            $('.welcome > p').toggleClass('transparent');
                            $('.welcome .date').toggleClass('transparent');
                            infoTimeOut = setTimeout(() => {
                                $infoDetailsContainer.fadeIn(500);
                                $infoDetailsContainer.removeClass('start')
                            }, 500)
                            
                    })
                }
                
            })

            $infoBar.on("click", "div", function() {
                $infoBar.css({
                    '--translate-btn': `${$(this).index() * $(this).outerWidth(true)}px`
                });
                container = document.querySelector('.info-details-container');
                container.scrollTo($(this).index() * $infoDetailsContainer.first().outerWidth(true), 250);
            });

            let group = getQueryParam('g');

            $.get(`https://api.nino-ricsi.wedding:3000/groups/${group}/guests`, function(data) {
                data.forEach(element => {
                    $infoTable.append(
                        `<div class="info-table-values" data-id="${element._id}">
                            <div class="name">${element.name}</div>
                            <div><input class="attending" type="checkbox" ${element.attending?'checked':''}></div>
                            <div><input class="vegetarian" type="checkbox" ${element.vegetarian?'checked':''}></div>
                            <div><input class="age3" type="checkbox" ${element.age3?'checked':''}></div>
                        </div>`
                    )
                });
            })

            let data = [];

            $infoSendButton.on("click", (event) => {
                data.length = 0;
                $(".info-table-values").each(function() {
                    data.push({
                        _id: $(this).data('id'),
                        attending: $(this).find('.attending').is(':checked'),
                        vegetarian: $(this).find('.vegetarian').is(':checked'),
                        age3: $(this).find('.age3').is(':checked')
                    })
                });
                $.ajax({
                    url: "https://api.nino-ricsi.wedding:3000/guests",
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function(data) {
                        console.log(data);
                    },
                    error: function(error) {
                        console.log('Error:', error);
                    }
                });
            }) 

        })
    </script>
</body>
</html>